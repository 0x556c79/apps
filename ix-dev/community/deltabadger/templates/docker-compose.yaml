{% set tpl = ix_lib.base.render.Render(values) %}

{# Setup permission container #}
{% set perm_container = tpl.deps.perms(values.consts.perms_container_name) %}
{% set perms_config = {"uid": values.run_as.user, "gid": values.run_as.group, "mode": "check"} %}

{# Create migrate container (runs once) #}
{% set migrate = tpl.add_container(values.consts.deltabadger_migrate_container_name, "image") %}
{% do migrate.set_user(values.run_as.user, values.run_as.group) %}
{% do migrate.set_command(["migrate"]) %}
{% do migrate.set_restart_policy("no") %}

{# Environment variables for migrate #}
{% do migrate.environment.add_env("RAILS_ENV", "production") %}
{% do migrate.environment.add_env("NODE_ENV", "production") %}
{% do migrate.environment.add_env("RAILS_LOG_TO_STDOUT", "true") %}
{% do migrate.environment.add_env("RAILS_SERVE_STATIC_FILES", "true") %}
{% do migrate.environment.add_env("SECRET_KEY_BASE", values.deltabadger.secret_key_base) %}
{% do migrate.environment.add_env("DEVISE_SECRET_KEY", values.deltabadger.devise_secret_key) %}
{% do migrate.environment.add_env("APP_ENCRYPTION_KEY", values.deltabadger.app_encryption_key) %}
{% do migrate.environment.add_env("DATABASE_PATH", "%s/production.sqlite3" | format(values.consts.storage_path)) %}
{% do migrate.environment.add_env("QUEUE_DATABASE_PATH", "%s/production_queue.sqlite3" | format(values.consts.storage_path)) %}
{% do migrate.environment.add_env("CACHE_DATABASE_PATH", "%s/production_cache.sqlite3" | format(values.consts.storage_path)) %}
{% do migrate.environment.add_env("CABLE_DATABASE_PATH", "%s/production_cable.sqlite3" | format(values.consts.storage_path)) %}

{# SMTP Configuration #}
{% if values.deltabadger.smtp_address %}
  {% do migrate.environment.add_env("SMTP_ADDRESS", values.deltabadger.smtp_address) %}
{% endif %}
{% if values.deltabadger.smtp_port %}
  {% do migrate.environment.add_env("SMTP_PORT", values.deltabadger.smtp_port) %}
{% endif %}
{% if values.deltabadger.smtp_domain %}
  {% do migrate.environment.add_env("SMTP_DOMAIN", values.deltabadger.smtp_domain) %}
{% endif %}
{% if values.deltabadger.smtp_username %}
  {% do migrate.environment.add_env("SMTP_USER_NAME", values.deltabadger.smtp_username) %}
{% endif %}
{% if values.deltabadger.smtp_password %}
  {% do migrate.environment.add_env("SMTP_PASSWORD", values.deltabadger.smtp_password) %}
{% endif %}
{% if values.deltabadger.notifications_sender %}
  {% do migrate.environment.add_env("NOTIFICATIONS_SENDER", values.deltabadger.notifications_sender) %}
{% endif %}

{# App URL Configuration #}
{% if values.deltabadger.app_root_url %}
  {% do migrate.environment.add_env("APP_ROOT_URL", values.deltabadger.app_root_url) %}
  {% do migrate.environment.add_env("HOME_PAGE_URL", values.deltabadger.app_root_url) %}
{% else %}
  {% set app_url = "http://%s:%d" | format(values.network.web_port.host_ips[0] if values.network.web_port.host_ips else "localhost", values.network.web_port.port_number) %}
  {% do migrate.environment.add_env("APP_ROOT_URL", app_url) %}
  {% do migrate.environment.add_env("HOME_PAGE_URL", app_url) %}
{% endif %}

{% do migrate.environment.add_env("ORDERS_FREQUENCY_LIMIT", values.deltabadger.orders_frequency_limit) %}
{% do migrate.environment.add_user_envs(values.deltabadger.additional_envs) %}

{# Storage for migrate #}
{% do migrate.add_storage(values.consts.storage_path, values.storage.data) %}
{% do migrate.add_storage(values.consts.logs_path, values.storage.logs) %}

{# Create web container #}
{% set web = tpl.add_container(values.consts.deltabadger_web_container_name, "image") %}
{% do web.set_user(values.run_as.user, values.run_as.group) %}
{% do web.set_command(["web"]) %}
{% do web.healthcheck.set_custom_test("curl -f http://localhost:3000/health-check") %}

{# Environment variables for web (same as migrate) #}
{% do web.environment.add_env("RAILS_ENV", "production") %}
{% do web.environment.add_env("NODE_ENV", "production") %}
{% do web.environment.add_env("RAILS_LOG_TO_STDOUT", "true") %}
{% do web.environment.add_env("RAILS_SERVE_STATIC_FILES", "true") %}
{% do web.environment.add_env("SECRET_KEY_BASE", values.deltabadger.secret_key_base) %}
{% do web.environment.add_env("DEVISE_SECRET_KEY", values.deltabadger.devise_secret_key) %}
{% do web.environment.add_env("APP_ENCRYPTION_KEY", values.deltabadger.app_encryption_key) %}
{% do web.environment.add_env("DATABASE_PATH", "%s/production.sqlite3" | format(values.consts.storage_path)) %}
{% do web.environment.add_env("QUEUE_DATABASE_PATH", "%s/production_queue.sqlite3" | format(values.consts.storage_path)) %}
{% do web.environment.add_env("CACHE_DATABASE_PATH", "%s/production_cache.sqlite3" | format(values.consts.storage_path)) %}
{% do web.environment.add_env("CABLE_DATABASE_PATH", "%s/production_cable.sqlite3" | format(values.consts.storage_path)) %}

{% if values.deltabadger.smtp_address %}
  {% do web.environment.add_env("SMTP_ADDRESS", values.deltabadger.smtp_address) %}
{% endif %}
{% if values.deltabadger.smtp_port %}
  {% do web.environment.add_env("SMTP_PORT", values.deltabadger.smtp_port) %}
{% endif %}
{% if values.deltabadger.smtp_domain %}
  {% do web.environment.add_env("SMTP_DOMAIN", values.deltabadger.smtp_domain) %}
{% endif %}
{% if values.deltabadger.smtp_username %}
  {% do web.environment.add_env("SMTP_USER_NAME", values.deltabadger.smtp_username) %}
{% endif %}
{% if values.deltabadger.smtp_password %}
  {% do web.environment.add_env("SMTP_PASSWORD", values.deltabadger.smtp_password) %}
{% endif %}
{% if values.deltabadger.notifications_sender %}
  {% do web.environment.add_env("NOTIFICATIONS_SENDER", values.deltabadger.notifications_sender) %}
{% endif %}

{% if values.deltabadger.app_root_url %}
  {% do web.environment.add_env("APP_ROOT_URL", values.deltabadger.app_root_url) %}
  {% do web.environment.add_env("HOME_PAGE_URL", values.deltabadger.app_root_url) %}
{% else %}
  {% set app_url = "http://%s:%d" | format(values.network.web_port.host_ips[0] if values.network.web_port.host_ips else "localhost", values.network.web_port.port_number) %}
  {% do web.environment.add_env("APP_ROOT_URL", app_url) %}
  {% do web.environment.add_env("HOME_PAGE_URL", app_url) %}
{% endif %}

{% do web.environment.add_env("ORDERS_FREQUENCY_LIMIT", values.deltabadger.orders_frequency_limit) %}
{% do web.environment.add_user_envs(values.deltabadger.additional_envs) %}

{# Port configuration #}
{% do web.add_port(values.network.web_port) %}

{# Storage for web #}
{% do web.add_storage(values.consts.storage_path, values.storage.data) %}
{% do web.add_storage(values.consts.logs_path, values.storage.logs) %}

{# Additional storage #}
{% for store in values.storage.additional_storage %}
  {% do web.add_storage(store.mount_path, store) %}
{% endfor %}

{# Web depends on migrate completion #}
{% do web.depends.add_dependency(values.consts.deltabadger_migrate_container_name, "service_completed_successfully") %}

{# Create jobs container #}
{% set jobs = tpl.add_container(values.consts.deltabadger_jobs_container_name, "image") %}
{% do jobs.set_user(values.run_as.user, values.run_as.group) %}
{% do jobs.set_command(["jobs"]) %}
{% do jobs.healthcheck.set_custom_test("pgrep -f 'solid_queue' || exit 1") %}

{# Environment variables for jobs (same as web) #}
{% do jobs.environment.add_env("RAILS_ENV", "production") %}
{% do jobs.environment.add_env("NODE_ENV", "production") %}
{% do jobs.environment.add_env("RAILS_LOG_TO_STDOUT", "true") %}
{% do jobs.environment.add_env("RAILS_SERVE_STATIC_FILES", "true") %}
{% do jobs.environment.add_env("SECRET_KEY_BASE", values.deltabadger.secret_key_base) %}
{% do jobs.environment.add_env("DEVISE_SECRET_KEY", values.deltabadger.devise_secret_key) %}
{% do jobs.environment.add_env("APP_ENCRYPTION_KEY", values.deltabadger.app_encryption_key) %}
{% do jobs.environment.add_env("DATABASE_PATH", "%s/production.sqlite3" | format(values.consts.storage_path)) %}
{% do jobs.environment.add_env("QUEUE_DATABASE_PATH", "%s/production_queue.sqlite3" | format(values.consts.storage_path)) %}
{% do jobs.environment.add_env("CACHE_DATABASE_PATH", "%s/production_cache.sqlite3" | format(values.consts.storage_path)) %}
{% do jobs.environment.add_env("CABLE_DATABASE_PATH", "%s/production_cable.sqlite3" | format(values.consts.storage_path)) %}

{% if values.deltabadger.smtp_address %}
  {% do jobs.environment.add_env("SMTP_ADDRESS", values.deltabadger.smtp_address) %}
{% endif %}
{% if values.deltabadger.smtp_port %}
  {% do jobs.environment.add_env("SMTP_PORT", values.deltabadger.smtp_port) %}
{% endif %}
{% if values.deltabadger.smtp_domain %}
  {% do jobs.environment.add_env("SMTP_DOMAIN", values.deltabadger.smtp_domain) %}
{% endif %}
{% if values.deltabadger.smtp_username %}
  {% do jobs.environment.add_env("SMTP_USER_NAME", values.deltabadger.smtp_username) %}
{% endif %}
{% if values.deltabadger.smtp_password %}
  {% do jobs.environment.add_env("SMTP_PASSWORD", values.deltabadger.smtp_password) %}
{% endif %}
{% if values.deltabadger.notifications_sender %}
  {% do jobs.environment.add_env("NOTIFICATIONS_SENDER", values.deltabadger.notifications_sender) %}
{% endif %}

{% if values.deltabadger.app_root_url %}
  {% do jobs.environment.add_env("APP_ROOT_URL", values.deltabadger.app_root_url) %}
  {% do jobs.environment.add_env("HOME_PAGE_URL", values.deltabadger.app_root_url) %}
{% else %}
  {% set app_url = "http://%s:%d" | format(values.network.web_port.host_ips[0] if values.network.web_port.host_ips else "localhost", values.network.web_port.port_number) %}
  {% do jobs.environment.add_env("APP_ROOT_URL", app_url) %}
  {% do jobs.environment.add_env("HOME_PAGE_URL", app_url) %}
{% endif %}

{% do jobs.environment.add_env("ORDERS_FREQUENCY_LIMIT", values.deltabadger.orders_frequency_limit) %}
{% do jobs.environment.add_user_envs(values.deltabadger.additional_envs) %}

{# Storage for jobs #}
{% do jobs.add_storage(values.consts.storage_path, values.storage.data) %}
{% do jobs.add_storage(values.consts.logs_path, values.storage.logs) %}

{# Additional storage for jobs #}
{% for store in values.storage.additional_storage %}
  {% do jobs.add_storage(store.mount_path, store) %}
{% endfor %}

{# Jobs depends on migrate completion #}
{% do jobs.depends.add_dependency(values.consts.deltabadger_migrate_container_name, "service_completed_successfully") %}

{# Setup permissions for storage #}
{% do perm_container.add_or_skip_action("data", values.storage.data, perms_config) %}
{% do perm_container.add_or_skip_action("logs", values.storage.logs, perms_config) %}
{% for store in values.storage.additional_storage %}
  {% do perm_container.add_or_skip_action(store.mount_path, store, perms_config) %}
{% endfor %}

{# Activate permissions container if needed #}
{% if perm_container.has_actions() %}
  {% do perm_container.activate() %}
  {% do migrate.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
{% endif %}

{# Add portal for web UI access #}
{% do tpl.portals.add(values.network.web_port, {"scheme": "http"}) %}

{# Render the final configuration #}
{{ tpl.render() | tojson }}
